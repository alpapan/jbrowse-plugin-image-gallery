"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@jbrowse/core/Plugin"),t=require("@jbrowse/core/pluggableElementTypes/ViewType"),a=require("@jbrowse/core/util"),r=require("mobx"),i=require("react"),l=require("mobx-react"),o=require("@mui/material"),n=require("@mui/icons-material/ExpandMore"),s=require("@mui/icons-material/ExpandLess"),u=require("@jbrowse/core/util/types/mst"),m=require("mobx-state-tree");function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=g(e),c=g(t),p=g(i),f=g(n),y=g(s);const h=e=>{try{return(new URL(e).pathname.split("/").pop()??"image").split("?")[0]}catch{return"image"}},b=({src:e,alt:t,maxHeight:a,onError:r,onLoad:l})=>{const[n,s]=i.useState(!0),[u,m]=i.useState(!1),g=i.useRef(null);return i.useEffect(()=>{const e=g.current;if(!e)return;if(e.dataset.src&&!e.src)return e.src=e.dataset.src,void e.removeAttribute("data-src");const t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const a=e.target;a.dataset.src&&!a.src&&(a.src=a.dataset.src,a.removeAttribute("data-src"),t.unobserve(a))}})},{threshold:.1});return t.observe(e),()=>t.disconnect()},[e]),u?p.default.createElement("img",{src:"https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg",alt:"Failed to load image",style:{maxHeight:a,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer"},onClick:()=>window.open(e,"_blank")}):p.default.createElement(o.Box,{sx:{position:"relative"}},n&&p.default.createElement(o.Skeleton,{variant:"rectangular",width:"100%",height:a,sx:{position:"absolute",top:0,left:0}}),p.default.createElement("img",{ref:g,"data-src":e,alt:t,style:{maxHeight:a,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer",display:n?"none":"block"},onLoad:()=>{s(!1),l()},onError:()=>{s(!1),m(!0),r("Failed to load image")},onClick:()=>window.open(e,"_blank")}))},w=l.observer(function({featureImages:e,featureImageLabels:t,featureImageTypes:a,feature:r,config:l}){const n=l??{},[s,u]=i.useState(new Map),[m,g]=i.useState(new Map),d=n?.maxImageWidth??300,c=n?.maxImageHeight??200,w=n?.enableLazyLoading??!0,x=n?.validateUrls??!0,I=n?.maxImages??50,E=i.useCallback(()=>{let i=[];if(e&&("string"==typeof e?i=e.split(",").map(e=>e.trim()).filter(e=>e.length>0):Array.isArray(e)&&(i=e.filter(e=>e&&"string"==typeof e).map(e=>e.trim()).filter(e=>e.length>0))),0===i.length&&r){const e=r.get("image")??r.get("images");e&&"string"==typeof e&&""!==e.trim()&&(i=e.split(",").map(e=>e.trim()).filter(e=>e.length>0))}const l=t??r?.get("image_group"),o=a??r?.get("image_tag");if(0===i.length)return[];const n=i.slice(0,I),s=l?l.split(",").map(e=>e.trim()):[],u=o?o.split(",").map(e=>e.trim()):[];return n.map((e,t)=>{const a={url:e,label:s[t]||`Image ${t+1}`,type:u[t]||"general",isLoading:!0,hasError:!1,displayName:h(e)};return x?(a.isValid=(e=>{if(!e||"string"!=typeof e)return!1;try{new URL(e)}catch{return!1}return/\.(jpg|jpeg|png|gif|bmp|webp|svg|tiff|ico)(\?.*)?$/i.test(e)})(e),a.isValid||(a.hasError=!0,a.isLoading=!1,a.errorMessage="Invalid image URL format")):a.isValid=!0,a})},[r,e,t,a,I,x]),v=E(),C=i.useCallback(e=>{const t=new Map;return e.forEach(e=>{const a=e.label;t.has(a)||t.set(a,[]),t.get(a).push(e)}),Array.from(t.entries()).map(([e,t])=>{const a=t.filter(e=>e.hasError).length;return{label:e,images:t,errorCount:a,validCount:t.length-a}})},[])(v),M=e=>s.get(e)??!0,k=i.useCallback(e=>{g(t=>{const a=new Map(t),r=a.get(e)??v[e];return a.set(e,{...r,isLoading:!1,hasError:!1}),a})},[v]),L=i.useCallback((e,t)=>{g(a=>{const r=new Map(a),i=r.get(e)??v[e];return r.set(e,{...i,isLoading:!1,hasError:!0,errorMessage:t}),r})},[v]);return 0===v.length?p.default.createElement(o.Alert,{severity:"info",sx:{mt:2}},"No images found for this feature. Make sure the feature has an 'images' attribute with comma-separated URLs."):p.default.createElement(o.Box,{sx:{mt:2}},C.map((e,t)=>p.default.createElement(o.Box,{key:t,sx:{mb:2,border:"1px solid #e0e0e0",borderRadius:1}},p.default.createElement(o.Box,{sx:{display:"flex",alignItems:"center",p:1,bgcolor:"grey.50",cursor:"pointer"},onClick:()=>{return t=e.label,void u(e=>{const a=new Map(e);return a.set(t,!M(t)),a});var t}},p.default.createElement(o.Typography,{variant:"subtitle1",sx:{flexGrow:1}},e.label," (",e.images.length,")",e.errorCount>0&&p.default.createElement(o.Chip,{label:`${e.errorCount} failed`,size:"small",color:"error",sx:{ml:1}})),p.default.createElement(o.IconButton,{size:"small"},M(e.label)?p.default.createElement(y.default,null):p.default.createElement(f.default,null))),p.default.createElement(o.Collapse,{in:M(e.label)},p.default.createElement(o.Box,{sx:{p:2}},e.errorCount>0&&p.default.createElement(o.Alert,{severity:"warning",sx:{mb:2}},e.errorCount," image",e.errorCount>1?"s":""," ","failed to load. Check the URLs and try again."),p.default.createElement(o.Grid,{container:!0,spacing:2},e.images.map((e,t)=>{const a=v.findIndex(t=>t.url===e.url),r=m.get(a)??e;return p.default.createElement(o.Grid,{size:{xs:12,sm:6},key:t},p.default.createElement(o.Card,{sx:{maxWidth:d}},r.hasError?p.default.createElement("img",{src:"https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg",alt:"Failed to load image",style:{maxHeight:c,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer"},onClick:()=>window.open(e.url,"_blank")}):w?p.default.createElement(b,{src:e.url,alt:e.displayName,maxHeight:c,onLoad:()=>k(a),onError:e=>L(a,e)}):p.default.createElement(o.CardMedia,{component:"img",sx:{maxHeight:c,objectFit:"contain",bgcolor:"grey.100",cursor:"pointer"},image:e.url,alt:e.displayName,onClick:()=>window.open(e.url,"_blank"),onLoad:()=>k(a),onError:()=>L(a,"Failed to load image")}),p.default.createElement(o.CardContent,{sx:{p:1}},p.default.createElement(o.Typography,{variant:"body2",noWrap:!0},e.displayName),"general"!==e.type&&p.default.createElement(o.Chip,{label:e.type,size:"small",color:"primary",sx:{mt:.5}}))))})))))))}),x=l.observer(function({model:e}){return e.hasImages?p.default.createElement(o.Paper,{elevation:12,sx:{padding:1,margin:1,minHeight:200},className:"MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation12 css-4h24oc-MuiPaper-root-viewContainer-unfocusedView"},p.default.createElement(o.Box,{sx:{mb:1}},p.default.createElement(o.Typography,{variant:"h6",sx:{fontSize:"1rem",fontWeight:"bold"}},e.displayTitle)),p.default.createElement(w,{featureImages:e.featureImages,featureImageLabels:e.featureImageLabels,featureImageTypes:e.featureImageTypes,config:{maxImages:10,maxImageHeight:200,validateUrls:!0}})):p.default.createElement(o.Paper,{elevation:12,sx:{padding:2,margin:1,minHeight:200,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},className:"MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation12 css-4h24oc-MuiPaper-root-viewContainer-unfocusedView"},p.default.createElement(o.Typography,{variant:"h6",color:"textSecondary"},"No feature with images selected"),p.default.createElement(o.Typography,{variant:"body2",color:"textSecondary",sx:{mt:1}},"When you select a feature with images, they will appear here"))}),I=m.types.model({id:u.ElementId,type:m.types.literal("ImageGalleryView"),selectedFeatureId:m.types.maybe(m.types.string),featureImages:m.types.maybe(m.types.string),featureImageLabels:m.types.maybe(m.types.string),featureImageTypes:m.types.maybe(m.types.string)}).actions(e=>({setWidth(){},updateFeature(t,a,r,i){e.selectedFeatureId=t,e.featureImages=a,e.featureImageLabels=r??"",e.featureImageTypes=i??""},clearFeature(){e.selectedFeatureId=void 0,e.featureImages=void 0,e.featureImageLabels=void 0,e.featureImageTypes=void 0}})).views(e=>({menuItems:()=>[],get hasImages(){return!(!e.featureImages||""===e.featureImages.trim())},get displayTitle(){return e.selectedFeatureId?`Images for ${String(e.selectedFeatureId)}`:"Image Gallery"}}));exports.default=class extends d.default{name="ImageGalleryPlugin";version="0.0.1";install(e){e.addViewType(()=>new c.default({name:"ImageGalleryView",stateModel:I,ReactComponent:x}));try{r.autorun(()=>{try{const t=e.rootModel?.session,a=t?.selection;let r,i;if(a){const e=a.feature??a;i=e,r=e&&"function"==typeof e.get?{id:e.get("id"),images:e.get("image")||e.get("images"),image_group:e.get("image_group"),image_tag:e.get("image_tag")}:String(e)}if(r&&"object"==typeof r&&r.images&&"none"!==r.images&&i)try{const e="imageGalleryView";let a=t?.views?t.views.find(t=>"ImageGalleryView"===t.type&&t.id===e):null;if(!a&&t&&(a=t.addView("ImageGalleryView",{id:e})),a?.updateFeature){const e=Array.isArray(r.images)?r.images.join(","):r.images,t=Array.isArray(r.image_group)?r.image_group.join(","):r.image_group,i=Array.isArray(r.image_tag)?r.image_tag.join(","):r.image_tag;a.updateFeature(r.id||"unknown",e,t,i)}}catch(e){}else try{const e="imageGalleryView";if(t?.views){const a=t.views.find(t=>"ImageGalleryView"===t.type&&t.id===e);a?.clearFeature&&a.clearFeature()}}catch(e){}}catch(e){}})}catch(e){}}configure(e){a.isAbstractMenuManager(e.rootModel)&&e.rootModel.appendToMenu("Add",{label:"Image Gallery View",onClick:e=>{e.addView("ImageGalleryView",{})}})}};
//# sourceMappingURL=jbrowse-plugin-image-gallery.cjs.production.min.js.map
