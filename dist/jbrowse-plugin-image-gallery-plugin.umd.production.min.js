var e,t;e=this,t=function(e,t,a,r,i,s,l,o,n,u,m,c){"use strict";function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=g(t),p=g(a),f=g(s),y=u.createSvgIcon(n.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),h=u.createSvgIcon(n.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess");const b=e=>{try{return(new URL(e).pathname.split("/").pop()??"image").split("?")[0]}catch{return"image"}},w=({src:e,alt:t,maxHeight:a,onError:r,onLoad:i})=>{const[l,n]=s.useState(!0),[u,m]=s.useState(!1),c=s.useRef(null);return s.useEffect(()=>{const e=c.current;if(!e)return;if(e.dataset.src&&!e.src)return e.src=e.dataset.src,void e.removeAttribute("data-src");const t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const a=e.target;a.dataset.src&&!a.src&&(a.src=a.dataset.src,a.removeAttribute("data-src"),t.unobserve(a))}})},{threshold:.1});return t.observe(e),()=>t.disconnect()},[e]),u?f.default.createElement("img",{src:"https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg",alt:"Failed to load image",style:{maxHeight:a,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer"},onClick:()=>window.open(e,"_blank")}):f.default.createElement(o.Box,{sx:{position:"relative"}},l&&f.default.createElement(o.Skeleton,{variant:"rectangular",width:"100%",height:a,sx:{position:"absolute",top:0,left:0}}),f.default.createElement("img",{ref:c,"data-src":e,alt:t,style:{maxHeight:a,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer",display:l?"none":"block"},onLoad:()=>{n(!1),i()},onError:()=>{n(!1),m(!0),r("Failed to load image")},onClick:()=>window.open(e,"_blank")}))},E=l.observer(function({featureImages:e,featureImageLabels:t,featureImageTypes:a,feature:r,config:i}){const l=i??{},[n,u]=s.useState(new Map),[m,c]=s.useState(new Map),g=l?.maxImageWidth??300,d=l?.maxImageHeight??200,p=l?.enableLazyLoading??!0,E=l?.validateUrls??!0,x=l?.maxImages??50,I=s.useCallback(()=>{let i=[];if(e&&("string"==typeof e?i=e.split(",").map(e=>e.trim()).filter(e=>e.length>0):Array.isArray(e)&&(i=e.filter(e=>e&&"string"==typeof e).map(e=>e.trim()).filter(e=>e.length>0))),0===i.length&&r){const e=r.get("image")??r.get("images");e&&"string"==typeof e&&""!==e.trim()&&(i=e.split(",").map(e=>e.trim()).filter(e=>e.length>0))}const s=t??r?.get("image_group"),l=a??r?.get("image_tag");if(0===i.length)return[];const o=i.slice(0,x),n=s?s.split(",").map(e=>e.trim()):[],u=l?l.split(",").map(e=>e.trim()):[];return o.map((e,t)=>{const a={url:e,label:n[t]||`Image ${t+1}`,type:u[t]||"general",isLoading:!0,hasError:!1,displayName:b(e)};return E?(a.isValid=(e=>{if(!e||"string"!=typeof e)return!1;try{new URL(e)}catch{return!1}return/\.(jpg|jpeg|png|gif|bmp|webp|svg|tiff|ico)(\?.*)?$/i.test(e)})(e),a.isValid||(a.hasError=!0,a.isLoading=!1,a.errorMessage="Invalid image URL format")):a.isValid=!0,a})},[r,e,t,a,x,E]),v=I(),N=s.useCallback(e=>{const t=new Map;return e.forEach(e=>{const a=e.label;t.has(a)||t.set(a,[]),t.get(a).push(e)}),Array.from(t.entries()).map(([e,t])=>{const a=t.filter(e=>e.hasError).length;return{label:e,images:t,errorCount:a,validCount:t.length-a}})},[])(v),j=e=>n.get(e)??!0,C=s.useCallback(e=>{c(t=>{const a=new Map(t),r=a.get(e)??v[e];return a.set(e,{...r,isLoading:!1,hasError:!1}),a})},[v]),k=s.useCallback((e,t)=>{c(a=>{const r=new Map(a),i=r.get(e)??v[e];return r.set(e,{...i,isLoading:!1,hasError:!0,errorMessage:t}),r})},[v]);return 0===v.length?f.default.createElement(o.Alert,{severity:"info",sx:{mt:2}},"No images found for this feature. Make sure the feature has an 'images' attribute with comma-separated URLs."):f.default.createElement(o.Box,{sx:{mt:2}},N.map((e,t)=>f.default.createElement(o.Box,{key:t,sx:{mb:2,border:"1px solid #e0e0e0",borderRadius:1}},f.default.createElement(o.Box,{sx:{display:"flex",alignItems:"center",p:1,bgcolor:"grey.50",cursor:"pointer"},onClick:()=>{return t=e.label,void u(e=>{const a=new Map(e);return a.set(t,!j(t)),a});var t}},f.default.createElement(o.Typography,{variant:"subtitle1",sx:{flexGrow:1}},e.label," (",e.images.length,")",e.errorCount>0&&f.default.createElement(o.Chip,{label:`${e.errorCount} failed`,size:"small",color:"error",sx:{ml:1}})),f.default.createElement(o.IconButton,{size:"small"},j(e.label)?f.default.createElement(h,null):f.default.createElement(y,null))),f.default.createElement(o.Collapse,{in:j(e.label)},f.default.createElement(o.Box,{sx:{p:2}},e.errorCount>0&&f.default.createElement(o.Alert,{severity:"warning",sx:{mb:2}},e.errorCount," image",e.errorCount>1?"s":""," ","failed to load. Check the URLs and try again."),f.default.createElement(o.Grid,{container:!0,spacing:2},e.images.map((e,t)=>{const a=v.findIndex(t=>t.url===e.url),r=m.get(a)??e;return f.default.createElement(o.Grid,{size:{xs:12,sm:6},key:t},f.default.createElement(o.Card,{sx:{maxWidth:g}},r.hasError?f.default.createElement("img",{src:"https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg",alt:"Failed to load image",style:{maxHeight:d,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer"},onClick:()=>window.open(e.url,"_blank")}):p?f.default.createElement(w,{src:e.url,alt:e.displayName,maxHeight:d,onLoad:()=>C(a),onError:e=>k(a,e)}):f.default.createElement(o.CardMedia,{component:"img",sx:{maxHeight:d,objectFit:"contain",bgcolor:"grey.100",cursor:"pointer"},image:e.url,alt:e.displayName,onClick:()=>window.open(e.url,"_blank"),onLoad:()=>C(a),onError:()=>k(a,"Failed to load image")}),f.default.createElement(o.CardContent,{sx:{p:1}},f.default.createElement(o.Typography,{variant:"body2",noWrap:!0},e.displayName),"general"!==e.type&&f.default.createElement(o.Chip,{label:e.type,size:"small",color:"primary",sx:{mt:.5}}))))})))))))}),x=l.observer(function({model:e}){return e.hasImages?f.default.createElement(o.Paper,{elevation:12,sx:{padding:1,margin:1,minHeight:200},className:"MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation12 css-4h24oc-MuiPaper-root-viewContainer-unfocusedView"},f.default.createElement(o.Box,{sx:{mb:1}},f.default.createElement(o.Typography,{variant:"h6",sx:{fontSize:"1rem",fontWeight:"bold"}},e.displayTitle)),f.default.createElement(E,{featureImages:e.featureImages,featureImageLabels:e.featureImageLabels,featureImageTypes:e.featureImageTypes,config:{maxImages:10,maxImageHeight:200,validateUrls:!0}})):f.default.createElement(o.Paper,{elevation:12,sx:{padding:2,margin:1,minHeight:200,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},className:"MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation12 css-4h24oc-MuiPaper-root-viewContainer-unfocusedView"},f.default.createElement(o.Typography,{variant:"h6",color:"textSecondary"},"No feature with images selected"),f.default.createElement(o.Typography,{variant:"body2",color:"textSecondary",sx:{mt:1}},"When you select a feature with images, they will appear here"))});var I;!function(e){e.GENE="GENE",e.NON_GENE="NON_GENE"}(I||(I={}));class v{selectedFeatureId;selectedFeatureType=I.NON_GENE;featureImages="";featureImageLabels="";featureImageTypes="";deduplicateImages(e){const t={};for(const a of e)a&&!t[a]&&(t[a]=a);return Object.keys(t)}}const N=c.types.model({id:m.ElementId,type:c.types.literal("ImageGalleryView"),displayName:c.types.optional(c.types.string,"Images"),minimized:c.types.optional(c.types.boolean,!1),selectedFeatureId:c.types.maybe(c.types.string),selectedFeatureType:c.types.optional(c.types.string,"GENE"),featureImages:c.types.maybe(c.types.string),featureImageLabels:c.types.maybe(c.types.string),featureImageTypes:c.types.maybe(c.types.string)}).actions(e=>({setWidth(){},setDisplayName(t){e.displayName=t},setMinimized(t){e.minimized=t},closeView(){try{const t=e.getRoot?.()?.session;t?.removeView&&t.removeView(e)}catch(e){console.error("Error closing view:",e)}},updateFeature(t,a,r,i,s){if(!t||!r)return void console.error("Invalid feature data");const l=r?r.split(",").map(e=>e.trim()).filter(e=>e.length>0):[],o=i?i.split(",").map(e=>e.trim()).filter(e=>e.length>0):[],n=s?s.split(",").map(e=>e.trim()).filter(e=>e.length>0):[],u=(new v).deduplicateImages(l);e.selectedFeatureId=t,e.selectedFeatureType=a.toString(),e.featureImages=u.join(","),e.featureImageLabels=o.join(","),e.featureImageTypes=n.join(",")},clearFeature(){e.selectedFeatureId=void 0,e.selectedFeatureType="GENE",e.featureImages=void 0,e.featureImageLabels=void 0,e.featureImageTypes=void 0}})).views(e=>({menuItems:()=>[],get hasImages(){return!(!e.featureImages||""===e.featureImages.trim())},get displayTitle(){return e.selectedFeatureId?`${e.displayName} for ${String(e.selectedFeatureId)}`:e.displayName}}));var j;!function(e){e.GENE="GENE",e.NON_GENE="NON_GENE"}(j||(j={})),e.default=class extends d.default{name="ImageGalleryPlugin";version="0.0.1";manuallyClosedViews=new Set;lastSelectedFeatureId=void 0;install(e){e.addViewType(()=>new p.default({name:"ImageGalleryView",stateModel:N,ReactComponent:x}));try{i.autorun(()=>{try{const t=e.rootModel?.session,a=t?.selection;let r,i;if(a){const e=a.feature??a;if(i=e,e&&"function"==typeof e.get){const t=this.collectImagesFromFeatureAndSubfeatures(e);r={id:e.get("id"),type:e.get("type"),images:t.images,image_group:t.labels,image_tag:t.types}}else r=String(e)}if(r&&"object"==typeof r&&r.images&&"none"!==r.images&&i)try{const e="imageGalleryView",a=`${e}-${r.id}`;if(this.lastSelectedFeatureId!==r.id&&(this.manuallyClosedViews.clear(),this.lastSelectedFeatureId=r.id),this.manuallyClosedViews.has(a))return;let i=t?.views?t.views.find(t=>"ImageGalleryView"===t.type&&t.id===e):null;if(!i&&t?.addView)try{i=t.addView("ImageGalleryView",{id:e,displayName:"Image Gallery (Auto)"})}catch(e){console.error("Failed to create ImageGalleryView:",e)}if(i?.updateFeature){const e=Array.isArray(r.images)?r.images.join(","):r.images,t=Array.isArray(r.image_group)?r.image_group.join(","):r.image_group,a=Array.isArray(r.image_tag)?r.image_tag.join(","):r.image_tag;i.updateFeature(r.id||"unknown","gene"===r.type?j.GENE:j.NON_GENE,e,t,a)}}catch(e){}else try{const e="imageGalleryView";if(t?.views){const a=t.views.find(t=>"ImageGalleryView"===t.type&&t.id===e);a?.clearFeature&&a.clearFeature()}}catch(e){}}catch(e){console.debug("Error in autorun logging",e)}})}catch(e){}}configure(e){r.isAbstractMenuManager(e.rootModel)&&e.rootModel.appendToMenu("Add",{label:"Image Gallery View",onClick:e=>{e.addView("ImageGalleryView",{})}})}collectImagesFromFeatureAndSubfeatures(e){const t=[],a=[],r=[],i=e=>{if(!e||"function"!=typeof e.get)return;const i=e.get("image")||e.get("images"),s=e.get("image_group"),l=e.get("image_tag");if(i&&"none"!==i){let e=[],o=[],n=[];Array.isArray(i)?e=i.map(e=>e.trim()).filter(e=>e.length>0):"string"==typeof i&&""!==i.trim()&&(e=i.split(",").map(e=>e.trim()).filter(e=>e.length>0)),s&&(Array.isArray(s)?o=s.map(e=>e.trim()).filter(e=>e.length>0):"string"==typeof s&&""!==s.trim()&&(o=s.split(",").map(e=>e.trim()).filter(e=>e.length>0))),l&&(Array.isArray(l)?n=l.map(e=>e.trim()).filter(e=>e.length>0):"string"==typeof l&&""!==l.trim()&&(n=l.split(",").map(e=>e.trim()).filter(e=>e.length>0))),e.length>0&&(t.push(...e),o.length>0&&o.length===e.length?a.push(...o):o.length>0?a.push(...e.map(()=>o[0]||"unlabeled")):a.push(...e.map(()=>"unlabeled")),n.length>0&&n.length===e.length?r.push(...n):n.length>0?r.push(...e.map(()=>n[0]||"unknown")):r.push(...e.map(()=>"unknown")))}};i(e);try{if(e.get&&"function"==typeof e.get){const t=e.get("subfeatures")||e.get("children")||[];if(Array.isArray(t)&&t.forEach(e=>{i(e)}),e.children&&"function"==typeof e.children){const t=e.children();Array.isArray(t)&&t.forEach(e=>{i(e)})}}}catch(e){console.debug("Error accessing subfeatures:",e)}const s=[],l=[],o=[],n=new Set;for(let e=0;e<t.length;e++){const i=t[e];i&&!n.has(i)&&(n.add(i),s.push(i),l.push(a[e]||"unlabeled"),o.push(r[e]||"unknown"))}return{images:s.join(","),labels:l.join(","),types:o.join(",")}}},Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@jbrowse/core/Plugin"),require("@jbrowse/core/pluggableElementTypes/ViewType"),require("@jbrowse/core/util"),require("mobx"),require("react"),require("mobx-react"),require("@mui/material"),require("react/jsx-runtime"),require("@mui/material/utils"),require("@jbrowse/core/util/types/mst"),require("mobx-state-tree")):"function"==typeof define&&define.amd?define(["exports","@jbrowse/core/Plugin","@jbrowse/core/pluggableElementTypes/ViewType","@jbrowse/core/util","mobx","react","mobx-react","@mui/material","react/jsx-runtime","@mui/material/utils","@jbrowse/core/util/types/mst","mobx-state-tree"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).JBrowsePluginImageGalleryPlugin={},e.JBrowseExports["@jbrowse/core/Plugin"],e.JBrowseExports["@jbrowse/core/pluggableElementTypes/ViewType"],e.JBrowseExports["@jbrowse/core/util"],e.JBrowseExports.mobx,e.JBrowseExports.react,e.JBrowseExports["mobx-react"],e.JBrowseExports["@mui/material"],e.JBrowseExports["react/jsx-runtime"],e.JBrowseExports["@mui/material/utils"],e.JBrowseExports["@jbrowse/core/util/types/mst"],e.JBrowseExports["mobx-state-tree"]);
//# sourceMappingURL=jbrowse-plugin-image-gallery-plugin.umd.production.min.js.map
