var e,t;e=this,t=function(e,t,a,r,i,o,s,l,n,m,u,g){"use strict";function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=c(t),p=c(a),f=c(o),y=m.createSvgIcon(n.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),b=m.createSvgIcon(n.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess");const w=e=>{try{return(new URL(e).pathname.split("/").pop()??"image").split("?")[0]}catch{return"image"}},h=({src:e,alt:t,maxHeight:a,onError:r,onLoad:i})=>{const[s,n]=o.useState(!0),[m,u]=o.useState(!1),g=o.useRef(null);return o.useEffect(()=>{const e=g.current;if(!e)return;if(e.dataset.src&&!e.src)return e.src=e.dataset.src,void e.removeAttribute("data-src");const t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const a=e.target;a.dataset.src&&!a.src&&(a.src=a.dataset.src,a.removeAttribute("data-src"),t.unobserve(a))}})},{threshold:.1});return t.observe(e),()=>t.disconnect()},[e]),m?f.default.createElement("img",{src:"https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg",alt:"Failed to load image",style:{maxHeight:a,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer"},onClick:()=>window.open(e,"_blank")}):f.default.createElement(l.Box,{sx:{position:"relative"}},s&&f.default.createElement(l.Skeleton,{variant:"rectangular",width:"100%",height:a,sx:{position:"absolute",top:0,left:0}}),f.default.createElement("img",{ref:g,"data-src":e,alt:t,style:{maxHeight:a,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer",display:s?"none":"block"},onLoad:()=>{n(!1),i()},onError:()=>{n(!1),u(!0),r("Failed to load image")},onClick:()=>window.open(e,"_blank")}))},x=s.observer(function({featureImages:e,featureImageLabels:t,featureImageTypes:a,feature:r,config:i}){const s=i??{},[n,m]=o.useState(new Map),[u,g]=o.useState(new Map),c=s?.maxImageWidth??300,d=s?.maxImageHeight??200,p=s?.enableLazyLoading??!0,x=s?.validateUrls??!0,E=s?.maxImages??50,I=o.useCallback(()=>{let i=[];if(e&&("string"==typeof e?i=e.split(",").map(e=>e.trim()).filter(e=>e.length>0):Array.isArray(e)&&(i=e.filter(e=>e&&"string"==typeof e).map(e=>e.trim()).filter(e=>e.length>0))),0===i.length&&r){const e=r.get("image")??r.get("images");e&&"string"==typeof e&&""!==e.trim()&&(i=e.split(",").map(e=>e.trim()).filter(e=>e.length>0))}const o=t??r?.get("image_group"),s=a??r?.get("image_tag");if(0===i.length)return[];const l=i.slice(0,E),n=o?o.split(",").map(e=>e.trim()):[],m=s?s.split(",").map(e=>e.trim()):[];return l.map((e,t)=>{const a={url:e,label:n[t]||`Image ${t+1}`,type:m[t]||"general",isLoading:!0,hasError:!1,displayName:w(e)};return x?(a.isValid=(e=>{if(!e||"string"!=typeof e)return!1;try{new URL(e)}catch{return!1}return/\.(jpg|jpeg|png|gif|bmp|webp|svg|tiff|ico)(\?.*)?$/i.test(e)})(e),a.isValid||(a.hasError=!0,a.isLoading=!1,a.errorMessage="Invalid image URL format")):a.isValid=!0,a})},[r,e,t,a,E,x]),v=I(),C=o.useCallback(e=>{const t=new Map;return e.forEach(e=>{const a=e.label;t.has(a)||t.set(a,[]),t.get(a).push(e)}),Array.from(t.entries()).map(([e,t])=>{const a=t.filter(e=>e.hasError).length;return{label:e,images:t,errorCount:a,validCount:t.length-a}})},[])(v),j=e=>n.get(e)??!0,M=o.useCallback(e=>{g(t=>{const a=new Map(t),r=a.get(e)??v[e];return a.set(e,{...r,isLoading:!1,hasError:!1}),a})},[v]),k=o.useCallback((e,t)=>{g(a=>{const r=new Map(a),i=r.get(e)??v[e];return r.set(e,{...i,isLoading:!1,hasError:!0,errorMessage:t}),r})},[v]);return 0===v.length?f.default.createElement(l.Alert,{severity:"info",sx:{mt:2}},"No images found for this feature. Make sure the feature has an 'images' attribute with comma-separated URLs."):f.default.createElement(l.Box,{sx:{mt:2}},C.map((e,t)=>f.default.createElement(l.Box,{key:t,sx:{mb:2,border:"1px solid #e0e0e0",borderRadius:1}},f.default.createElement(l.Box,{sx:{display:"flex",alignItems:"center",p:1,bgcolor:"grey.50",cursor:"pointer"},onClick:()=>{return t=e.label,void m(e=>{const a=new Map(e);return a.set(t,!j(t)),a});var t}},f.default.createElement(l.Typography,{variant:"subtitle1",sx:{flexGrow:1}},e.label," (",e.images.length,")",e.errorCount>0&&f.default.createElement(l.Chip,{label:`${e.errorCount} failed`,size:"small",color:"error",sx:{ml:1}})),f.default.createElement(l.IconButton,{size:"small"},j(e.label)?f.default.createElement(b,null):f.default.createElement(y,null))),f.default.createElement(l.Collapse,{in:j(e.label)},f.default.createElement(l.Box,{sx:{p:2}},e.errorCount>0&&f.default.createElement(l.Alert,{severity:"warning",sx:{mb:2}},e.errorCount," image",e.errorCount>1?"s":""," ","failed to load. Check the URLs and try again."),f.default.createElement(l.Grid,{container:!0,spacing:2},e.images.map((e,t)=>{const a=v.findIndex(t=>t.url===e.url),r=u.get(a)??e;return f.default.createElement(l.Grid,{size:{xs:12,sm:6},key:t},f.default.createElement(l.Card,{sx:{maxWidth:c}},r.hasError?f.default.createElement("img",{src:"https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg",alt:"Failed to load image",style:{maxHeight:d,width:"100%",objectFit:"contain",backgroundColor:"#f5f5f5",cursor:"pointer"},onClick:()=>window.open(e.url,"_blank")}):p?f.default.createElement(h,{src:e.url,alt:e.displayName,maxHeight:d,onLoad:()=>M(a),onError:e=>k(a,e)}):f.default.createElement(l.CardMedia,{component:"img",sx:{maxHeight:d,objectFit:"contain",bgcolor:"grey.100",cursor:"pointer"},image:e.url,alt:e.displayName,onClick:()=>window.open(e.url,"_blank"),onLoad:()=>M(a),onError:()=>k(a,"Failed to load image")}),f.default.createElement(l.CardContent,{sx:{p:1}},f.default.createElement(l.Typography,{variant:"body2",noWrap:!0},e.displayName),"general"!==e.type&&f.default.createElement(l.Chip,{label:e.type,size:"small",color:"primary",sx:{mt:.5}}))))})))))))}),E=s.observer(function({model:e}){return e.hasImages?f.default.createElement(l.Paper,{elevation:12,sx:{padding:1,margin:1,minHeight:200},className:"MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation12 css-4h24oc-MuiPaper-root-viewContainer-unfocusedView"},f.default.createElement(l.Box,{sx:{mb:1}},f.default.createElement(l.Typography,{variant:"h6",sx:{fontSize:"1rem",fontWeight:"bold"}},e.displayTitle)),f.default.createElement(x,{featureImages:e.featureImages,featureImageLabels:e.featureImageLabels,featureImageTypes:e.featureImageTypes,config:{maxImages:10,maxImageHeight:200,validateUrls:!0}})):f.default.createElement(l.Paper,{elevation:12,sx:{padding:2,margin:1,minHeight:200,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},className:"MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation12 css-4h24oc-MuiPaper-root-viewContainer-unfocusedView"},f.default.createElement(l.Typography,{variant:"h6",color:"textSecondary"},"No feature with images selected"),f.default.createElement(l.Typography,{variant:"body2",color:"textSecondary",sx:{mt:1}},"When you select a feature with images, they will appear here"))}),I=g.types.model({id:u.ElementId,type:g.types.literal("ImageGalleryView"),displayName:g.types.maybe(g.types.string),selectedFeatureId:g.types.maybe(g.types.string),featureImages:g.types.maybe(g.types.string),featureImageLabels:g.types.maybe(g.types.string),featureImageTypes:g.types.maybe(g.types.string)}).actions(e=>({setWidth(){},setDisplayName(t){e.displayName=t},updateFeature(t,a,r,i){e.selectedFeatureId=t,e.featureImages=a,e.featureImageLabels=r??"",e.featureImageTypes=i??""},clearFeature(){e.selectedFeatureId=void 0,e.featureImages=void 0,e.featureImageLabels=void 0,e.featureImageTypes=void 0}})).views(e=>({menuItems:()=>[],get hasImages(){return!(!e.featureImages||""===e.featureImages.trim())},get displayTitle(){return e.displayName??(e.selectedFeatureId?`Images for ${String(e.selectedFeatureId)}`:"Images")}}));e.default=class extends d.default{name="ImageGalleryPlugin";version="0.0.1";install(e){e.addViewType(()=>new p.default({name:"ImageGalleryView",stateModel:I,ReactComponent:E}));try{i.autorun(()=>{try{const t=e.rootModel?.session,a=t?.selection;let r,i;if(a){const e=a.feature??a;i=e,r=e&&"function"==typeof e.get?{id:e.get("id"),images:e.get("image")||e.get("images"),image_group:e.get("image_group"),image_tag:e.get("image_tag")}:String(e)}if(r&&"object"==typeof r&&r.images&&"none"!==r.images&&i)try{const e="imageGalleryView";let a=t?.views?t.views.find(t=>"ImageGalleryView"===t.type&&t.id===e):null;if(!a&&t&&(a=t.addView("ImageGalleryView",{id:e})),a?.updateFeature){const e=Array.isArray(r.images)?r.images.join(","):r.images,t=Array.isArray(r.image_group)?r.image_group.join(","):r.image_group,i=Array.isArray(r.image_tag)?r.image_tag.join(","):r.image_tag;a.updateFeature(r.id||"unknown",e,t,i)}}catch(e){}else try{const e="imageGalleryView";if(t?.views){const a=t.views.find(t=>"ImageGalleryView"===t.type&&t.id===e);a?.clearFeature&&a.clearFeature()}}catch(e){}}catch(e){}})}catch(e){}}configure(e){r.isAbstractMenuManager(e.rootModel)&&e.rootModel.appendToMenu("Add",{label:"Image Gallery View",onClick:e=>{e.addView("ImageGalleryView",{})}})}},Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@jbrowse/core/Plugin"),require("@jbrowse/core/pluggableElementTypes/ViewType"),require("@jbrowse/core/util"),require("mobx"),require("react"),require("mobx-react"),require("@mui/material"),require("react/jsx-runtime"),require("@mui/material/utils"),require("@jbrowse/core/util/types/mst"),require("mobx-state-tree")):"function"==typeof define&&define.amd?define(["exports","@jbrowse/core/Plugin","@jbrowse/core/pluggableElementTypes/ViewType","@jbrowse/core/util","mobx","react","mobx-react","@mui/material","react/jsx-runtime","@mui/material/utils","@jbrowse/core/util/types/mst","mobx-state-tree"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).JBrowsePluginImageGalleryPlugin={},e.JBrowseExports["@jbrowse/core/Plugin"],e.JBrowseExports["@jbrowse/core/pluggableElementTypes/ViewType"],e.JBrowseExports["@jbrowse/core/util"],e.JBrowseExports.mobx,e.JBrowseExports.react,e.JBrowseExports["mobx-react"],e.JBrowseExports["@mui/material"],e.JBrowseExports["react/jsx-runtime"],e.JBrowseExports["@mui/material/utils"],e.JBrowseExports["@jbrowse/core/util/types/mst"],e.JBrowseExports["mobx-state-tree"]);
//# sourceMappingURL=jbrowse-plugin-image-gallery-plugin.umd.production.min.js.map
